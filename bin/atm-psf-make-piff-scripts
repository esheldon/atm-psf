#!/usr/bin/env python

SCRIPT = r"""#!/usr/bin/bash
# make sure to source ~/imsim-setup/imsim-setup.sh first
seed=$1
image=$2
truth=$3
piff=$4
source=$5

atm-psf-run-piff \
        --seed $seed \
        --image $image \
        --truth $truth \
        --piff $piff \
        --sources $sources
"""

CONDOR_HEAD = r"""
Universe = vanilla

Notification = Never

# Run this exe with these args
Executable = run.sh

request_memory = 2G

GetEnv = True

kill_sig = SIGINT

# transfer_input_files = %(imsim_config)s

+Experiment = "astro"

"""

JOB_TEMPLATE = r"""
+job_name = "%(job_name)s"
arguments = %(seed)d %(image)s %(truth)s %(piff)s %(sources)s
Queue
"""


def get_args():
    import argparse
    parser = argparse.ArgumentParser()
    parser.add_argument('config')
    return parser.parse_args()


def load_config(fname):
    import yaml
    with open(fname) as fobj:
        data = yaml.safe_load(fobj)
    return data


def write_script(run_dir):
    import os

    outfile = f'{run_dir}/run.sh'
    print('writing:', outfile)

    with open(outfile, 'w') as fobj:
        fobj.write(SCRIPT)
    os.system(f'chmod 755 {outfile}')


def makedir(d):
    import os
    if not os.path.exists(d):
        print('making dir:', d)
        os.makedirs(d)


def write_condor_head(condorf, config):
    import os
    head = CONDOR_HEAD % {
        'imsim_config': os.path.basename(config['imsim_config']),
        'memory': config['memory'],
    }
    condorf.write(head)


def get_files(directory):
    import os

    flist = []
    for root, dirs, files in os.walk(directory, topdown=False):
        for basename in files:
            if 'eimage' in basename:
                fname = os.path.join(root, basename)
                fname = os.path.abspath(fname)
                flist.append(fname)

    flist.sort()

    dlist = []
    for image_fname in flist:
        truth_fname = image_fname.replace('eimage-', 'truth-')
        assert truth_fname != image_fname
        if not os.path.exists(truth_fname):
            raise RuntimeError(f'{truth_fname} not found')

        d = {'image': image_fname, 'truth': truth_fname}
        dlist.append(d)

    return dlist


def main():
    import os
    import numpy as np

    args = get_args()

    config = load_config(args.config)
    rng = np.random.default_rng(config['seed'])

    sim_run_dir = config['sim_dir']
    dlist = get_files(sim_run_dir)
    print('found:', len(dlist), 'eimage files')

    run_dir = os.path.join(config['base_dir'], config['run'])
    makedir(run_dir)

    write_script(run_dir)
    condor_file = os.path.join(run_dir, 'submit.condor')
    print('opening:', condor_file)
    with open(condor_file, 'w') as condorf:

        for i, data in enumerate(dlist):
            write_condor_head(condorf, config)

            ipad = '%05d' % i

            job_name = f'{config["run"]}-{ipad}'
            jobtext = JOB_TEMPLATE % {
                'job_name': job_name,
                'seed': rng.integers(0, 2**20),
                'image': data['image'],
                'truth': data['truth'],
                'piff': piff_file,
                'sources': source_file,
            }
            condorf.write(jobtext)


if __name__ == '__main__':
    main()
