#!/usr/bin/env python

import os
from atm_psf.process import (
    run_make_instcat, run_galsim, get_instcat_output_path,
)
from atm_psf.io import load_config


def get_args():
    import argparse
    parser = argparse.ArgumentParser()
    parser.add_argument('--run-config', required=True)
    parser.add_argument('--imsim-config', required=True)
    parser.add_argument('--opsim-db', required=True)
    parser.add_argument('--obsid', type=int, required=True)
    parser.add_argument('--instcat', required=True)
    parser.add_argument('--ccds', required=True,
                        help='e.g. "[35,66]"')
    parser.add_argument('--seed', type=int, required=True)
    parser.add_argument(
        '--use-existing',
        action='store_true',
        help='Re-use instcat if it already exists',
    )
    return parser.parse_args()


if __name__ == '__main__':
    args = get_args()

    run_config = load_config(args.run_config)

    instcat_out = get_instcat_output_path(args.obsid)

    if not os.path.exists(instcat_out) or not args.use_existing:
        run_make_instcat(
            run_config=run_config,
            opsim_db=args.opsim_db,
            obsid=args.obsid,
            instcat_out=instcat_out,
            ccds=args.ccds,
            seed=args.seed,
        )

    run_galsim(
        imsim_config=args.imsim_config,
        instcat=instcat_out,
        ccds=args.ccds,
    )
